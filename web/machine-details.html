<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Machine Details</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&amp;display=swap" rel="stylesheet" style="cursor: pointer;">
    <link rel="stylesheet" href="style.css">
    <style>
table {
    position: relative;
    border-radius: 30px;
    box-shadow: var(--shadow-float);
    border: none;
    overflow: hidden;
    z-index: 2;
}
table th {
    text-align: center;
    vertical-align: middle;
    background-color: inherit;
    background-color: var(--color-bright);
}
table td {
    text-align: center;
    vertical-align: middle;
    background-color: rgb(249 249 249);
    padding: 25px 0;
    font-size: 20px;
}
div:has(> .behind-btn) {
    position: relative;
}
.behind-btn {
    position: absolute;
    display: block;
    bottom: calc(-1.7rem - 10px);
    border-radius: 10px;
    right: 1px;
    padding: 5px 15px;
    padding-top: 5rem;
    background-color: var(--color-bright);
    border: 1px solid var(--color-accent);
    color: var(--color-accent);
    cursor: pointer;
}
#navigation-buttons {
    display: flex;
    gap: 20px;
    width: var(--page-margin-width);
    max-width: var(--page-margin-max-width);
}
#navigation-buttons button {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    border-radius: 20px;
    background-color: var(--color-bright);
    box-shadow: var(--shadow-float);
    cursor: pointer;
    font-weight: bold;
}
#navigation-buttons button.back {
    flex: 1;
    font-size: 22px;
}
#navigation-buttons button.claim {
    flex: 2;
    padding: 50px 0;
    font-size: 40px;
    color: var(--color-green);
}

#repair-msg-box {
    width: calc(var(--page-margin-width) - 40px);
    max-width: calc(var(--page-margin-max-width) - 40px);
    background-color: var(--color-red-transparent);
    box-shadow: var(--shadow-float);
    border: 2px solid var(--color-red);
    border-radius: 10px;
    padding: 20px;
    display: flex;
    justify-content: space-between;
}
#repair-msg-box .msg {
    margin: 0;
    font-size: 18px;
    position: relative;
    flex: 1;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    gap: 1rem;
}
#repair-msg-box .img {
    position: relative;
    border-radius: 10px;
    padding-bottom: -10px;
    width: 150px;
    height: 100px;
    overflow: hidden;
    cursor: pointer;
    padding: 0;
}
#repair-msg-box .img::after {
    content: "+";
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    padding: 2px 15px;
    border-radius: 7px;
    font-size: 20px;
    border: 2px solid var(--color-accent);
    color: var(--color-accent);
    background-color: rgba(255, 255, 255, .8);
}
#repair-msg-box .img img {
    width: 100%;
    height: 100%;
    margin: 0;
    padding: 0;
    object-fit: cover;
    opacity: .8;
}
    </style>
</head>
<body>
    <sidebar-container></sidebar-container>
    <navbar></navbar>

    <spacer style="height: 120px;"></spacer>

    <div class="full-width" style="margin-bottom: calc(1.7rem + 10px);">
        <table id="machine-table" style="width: 100%;" cellspacing="0">
            <tr>
                <th>Serial #</th>
                <td>‚Äì</td>
                <th>Avaiable</th>
                <td>‚Äì</td>
            </tr>
            <tr>
                <th>Territory</th>
                <td>‚Äì</td>
                <th>Renting</th>
                <td>‚Äì</td>
            </tr>
            <tr>
                <th>Req. Terr</th>
                <td>‚Äì</td>
                <th>Pickup</th>
                <td>‚Äì</td>
            </tr>
            <tr>
                <th>Consigned</th>
                <td>‚Äì</td>
                <th>Active Status</th>
                <td>‚Äì</td>
            </tr>
        </table>
        <div class="behind-btn">Edit in AppServer</div>
    </div>
    
    <spacer style="height: 50px;"></spacer>

    <div id="repair-msg-box" style="display: none;">
        <div class="msg">
            <span class="date">‚Äì</span>
            <span class="note">‚Äì</span>
        </div>
        <div class="img" style="display: none;">
            <img src="" alt="Kinex Logo">
        </div>
    </div>
    
    <spacer style="height: 50px;"></spacer>

    <div id="navigation-buttons">
        <button class="back" onclick="window.history.back();">
            <arrow-left></arrow-left>
            Back to scanner
        </button>
        <button class="claim">Claim & Clean</button>
    </div>


    <recent-activity-button onclick="this.nextElementSibling.classList.add('active');">Recent Activity</recent-activity-button>

    <bottom-drawer-container></bottom-drawer-container>


    <script src="every-page.js"></script>
    <script src="fetcher.js"></script>
    <script src="AppServer.js"></script>
    <script src="handle-scans.js"></script>
    <script src="WorkDay.js"></script>

    <script>
// get constants
const machineTable = document.getElementById('machine-table');

// set scan handler
HandleScans.onScan = (s) => {
    sessionStorage.setItem('current_serial_number', s.stripExtraChars());
    location.href = 'machine-details.html';
};

// set claim button text and function
const claimButton = document.querySelector('#navigation-buttons .claim');
claimButton.innerHTML = "Claim & "+Kinex_Role.slice(0, -2);
claimButton.onclick = async () => {
    if (Kinex_Role.toLowerCase() == 'cleaner') {
        await WorkDay.addCleaner(SN, 0);
        window.location.href = "clean.html?code=" + SN;
    } else {
        await WorkDay.addRepairer(SN, 0);
        window.location.href = "repair.html?code=" + SN;
    }
}

// get machine code
const SN = sessionStorage.getItem('current_serial_number');
if (!SN) {
    window.history.back();
}

async function populateMachine() {
    let searchResults = await AppServer.searchInventory(SN);

    // check if machine doesn't exist or too many
    if (searchResults.length != 1) {
        console.error("Expected 1 result for serial number " + SN + ". Got " + searchResults.length);
        window.history.back();
        return;
    }
    window.machine = searchResults[0];

    // fill in table
    machineTable.innerHTML = `
        <tr>
            <th>Serial #</th>
            <td>${machine.SerialNumber}</td>
            <th>Avaiable</th>
            <td>${machine.IsAvailable ? "‚úÖ" : "‚ùå"}</td>
        </tr>
        <tr>
            <th>Territory</th>
            <td>${machine.TerritoryName}</td>
            <th>Renting</th>
            <td>${machine.IsRenting ? "‚úÖ" : "‚ùå"}</td>
        </tr>
        <tr>
            <th>Req. Terr</th>
            <td>${machine.RequestedTerritoryName ? machine.RequestedTerritoryName : "‚Äì"}</td>
            <th>Pickup</th>
            <td>${machine.IsPickup ? "‚úÖ" : "‚ùå"}</td>
        </tr>
        <tr>
            <th>Consigned</th>
            <td>${machine.ConsignedCustomerName ? machine.ConsignedCustomerName : "‚Äì"}</td>
            <th>Active Status</th>
            <td>${machine.StatusName}</td>
        </tr>
    `;

    // get most recent activities
    let activities = await machine.getAllActivities();

    // fill in activity table
    let activityTable = document.querySelector('recent-activity');
    activityTable.innerHTML = activities.map(x => {
        return `<activity class="${x.IsComplete ? "" : "incomplete"}"><div>${x.AppServerTitle}</div><div>${x.Note}</div></activity>`
    }).join('');

    // find if any of the activities are a message for repair
    let repairMessage = activities.find(x => x.ActivityTypeName == "Repair Status" && x.IsComplete == false);
    if (repairMessage) {
        // show message
        document.getElementById('repair-msg-box').style.display = 'flex';
        document.querySelector('#repair-msg-box .msg .note').innerHTML = repairMessage.Note;
        document.querySelector('#repair-msg-box .msg .date').innerHTML = "üè¥ Modified on " + new Date(repairMessage.ModifiedDate).toLocaleDateString() + ", by: " + repairMessage.cn;
    } else {
        // hide message
        document.getElementById('repair-msg-box').style.display = 'none';
    }

}
populateMachine();
    </script>
</body>
</html>